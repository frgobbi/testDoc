services:

  #============================================================#
  #                   TRAEFIK REVERSE PROXY                    #
  #============================================================#
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      # Enables API
      - "--api=true"
      # Enable dashboard
      - "--api.dashboard=true"
      # Docker provider configuration
      - "--providers.docker=true"
      # Makes sure that services have to explicitly expose themselves
      - "--providers.docker.exposedbydefault=false"
      # Entrypoints configuration
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=web-secure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.web-secure.address=:443"
      - "--entrypoints.dashboard.address=:8080"
      - "--entrypoints.portainer.address=:9000"
      - "--entrypoints.jenkins.address=:8081"
      # Logging level
      - "--log.level=info"
      # Let's Encrypt configuration
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=gobbi97@live.it"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
      - "9000:9000"
      - "8081:8081"
    labels:
      traefik.enable: 'true'

      ## Dashboard unsecure
      traefik.http.routers.traefik-dashboard-http-router.entrypoints: dashboard
      traefik.http.routers.traefik-dashboard-http-router.rule: PathPrefix(`/`)
      traefik.http.routers.traefik-dashboard-http-router.service: api@internal
      traefik.http.middlewares.traefik-dashboard-auth.basicauth.users: admin:$$apr1$$47880OD1$$pZ7EB2Jq4e4fyDVCYRDAK/
      traefik.http.routers.traefik-dashboard-http-router.middlewares: traefik-dashboard-auth
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - proxy
    restart: unless-stopped

  #============================================================#
  #                PORTAINER CONTAINER MANAGER                 #
  #============================================================#
  portainer:
    image: portainer/portainer-ce:2.20.3
    container_name: portainer
    restart: always
    environment:
      ADMIN_PASSWORD: "C1rcolo!"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      traefik.enable: true
      traefik.docker.network: proxy
      traefik.http.routers.portainer.rule: PathPrefix(`/`)
      traefik.http.routers.portainer.entrypoints: portainer
      traefik.http.routers.portainer.service: portainer
      traefik.http.services.portainer.loadbalancer.server.port: 9000
    networks:
      - proxy

  #============================================================#
  #                   JENKINS CI/CD MANAGER                    #
  #============================================================#
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    group_add:
      - "998"
    # user: "1000:987"  # Rimuovere/commentare se non serve
    ports:
      - "50000:50000"
    labels:
      traefik.enable: true
      traefik.http.routers.jenkins.rule: PathPrefix(`/`)
      traefik.http.routers.jenkins.entrypoints: jenkins
      traefik.http.routers.jenkins.service: jenkins
      traefik.http.services.jenkins.loadbalancer.server.port: 8080
    environment:
      JAVA_OPTS: -Duser.timezone=Europe/Rome
    networks:
      - proxy
    volumes:
      - jenkins_data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    command: |
      bash -c "
      set -e
      export PATH=/tmp:$$PATH
      if [ ! -f /tmp/docker-compose ]; then
        echo 'Installing docker-compose...'
        cd /tmp
        curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-$$(uname -s)-$$(uname -m)\" -o docker-compose
        chmod +x docker-compose
        /tmp/docker-compose --version && echo 'docker-compose installed successfully'
      fi
      echo 'Installing/Updating Docker CLI...'
      cd /tmp
      rm -f docker docker-cli.tgz
      curl -fsSL https://download.docker.com/linux/static/stable/x86_64/docker-25.0.5.tgz -o docker-cli.tgz
      mkdir -p docker-extract
      tar -xz -f docker-cli.tgz -C docker-extract
      chmod +x docker-extract/docker/docker
      cp docker-extract/docker/docker /tmp/docker
      rm -rf docker-extract docker-cli.tgz
      /tmp/docker --version && echo 'docker CLI installed successfully'
      echo 'export PATH=/tmp:$$PATH' >> /var/jenkins_home/.bashrc 2>/dev/null || true
      echo 'export PATH=/tmp:$$PATH' >> /var/jenkins_home/.profile 2>/dev/null || true
      echo 'Verification:'
      /tmp/docker --version || echo 'Docker CLI check failed'
      /tmp/docker-compose --version || echo 'Docker-compose check failed'
      exec /usr/local/bin/jenkins.sh
      "
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    volumes:
      - ./authelia/configuration.yml:/config/configuration.yml:ro
      - ./authelia/users_database.yml:/config/users_database.yml:ro
      - ./authelia/db:/config/db
      - ./authelia/session:/config/session
    environment:
      TZ: Europe/Rome
    labels:
      traefik.enable: true
      traefik.docker.network: proxy
      # UI di login (pagina grafica)
      traefik.http.routers.authelia.rule: Host(`auth.polisportivacastelvieto.it`)
      traefik.http.routers.authelia.entrypoints: web-secure
      traefik.http.routers.authelia.tls: true
      traefik.http.routers.authelia.tls.certresolver: letsencrypt
      traefik.http.services.authelia.loadbalancer.server.port: 9091
      # Middleware usato dalla doc (forward auth)
      traefik.http.middlewares.doc-auth.forwardauth.address: http://authelia:9091/api/authz/forward-auth
      traefik.http.middlewares.doc-auth.forwardauth.trustForwardHeader: "true"
      traefik.http.middlewares.doc-auth.forwardauth.authResponseHeaders: Remote-User,Remote-Groups,Remote-Name,Remote-Email
    networks:
      - proxy
 
volumes:
  portainer_data:
  jenkins_data:

networks:
  proxy:
    driver: bridge
    name: proxy